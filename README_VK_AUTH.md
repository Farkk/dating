# Инструкция по настройке авторизации через ВКонтакте

## 1. Создание приложения ВКонтакте

1. Перейдите на страницу управления приложениями: https://vk.com/apps?act=manage
2. Нажмите "Создать приложение"
3. Заполните форму:
   - Название: Dating Site (или ваше название)
   - Платформа: Веб-сайт
   - Адрес сайта: http://localhost:8000
   - Базовый домен: localhost
4. Подтвердите создание приложения

## 2. Настройка приложения

1. После создания откройте настройки приложения
2. Перейдите в раздел "Настройки"
3. Скопируйте:
   - **ID приложения** (App ID)
   - **Защищённый ключ** (Secret Key)
4. В разделе "Настройки" → "Authorized redirect URI" добавьте:
   ```
   http://localhost:8000/auth/vk_callback.php
   ```

## 3. Конфигурация проекта

1. Откройте файл `config/vk_config.php`
2. Замените значения:
   ```php
   define('VK_APP_ID', 'ВАШ_APP_ID');
   define('VK_APP_SECRET', 'ВАШ_SECRET_KEY');
   ```

## 4. Создание директории для загрузки фото

Создайте директорию для хранения фотографий пользователей:

```bash
mkdir -p uploads/photos
chmod 755 uploads/photos
```

## 5. Запуск приложения

1. Убедитесь, что PostgreSQL запущен:
   ```bash
   psql -U postgres -c "SELECT version();"
   ```

2. База данных уже обновлена с полями для VK авторизации

3. Запустите PHP сервер:
   ```bash
   php -S localhost:8000
   ```

4. Откройте в браузере:
   ```
   http://localhost:8000/auth/login.php
   ```

## Структура файлов

```
/
├── auth/
│   ├── login.php           # Страница входа с кнопкой ВК
│   ├── vk_callback.php     # Обработчик OAuth callback
│   ├── logout.php          # Выход из системы
│   └── check_auth.php      # Проверка авторизации
├── profile/
│   ├── edit.php            # Редактирование профиля
│   ├── upload_photo.php    # Загрузка фотографий
│   └── delete_photo.php    # Удаление фотографий
├── config/
│   ├── vk_config.php       # Конфигурация ВК OAuth
│   ├── db.php              # Подключение к БД
│   └── init_db.sql         # Обновленная схема БД
├── uploads/
│   └── photos/             # Фотографии пользователей
│       └── {user_id}/      # Папка для каждого пользователя
└── index.php               # Главная страница (требует авторизации)
```

## Как это работает

### 1. Авторизация через ВКонтакте

1. Пользователь нажимает "Войти через ВКонтакте" на странице `/auth/login.php`
2. Перенаправляется на OAuth страницу ВК для подтверждения доступа
3. После подтверждения ВК перенаправляет на `/auth/vk_callback.php` с кодом авторизации
4. Callback обменивает код на access token
5. Получает данные пользователя из VK API
6. Проверяет, существует ли пользователь в базе:
   - Если **существует**: обновляет токен и создаёт сессию
   - Если **не существует**: создаёт нового пользователя, скачивает фото профиля из ВК
7. Создаёт сессию в таблице `user_sessions`
8. Перенаправляет на страницу редактирования профиля

### 2. Работа с профилем

- **Редактирование**: `/profile/edit.php` - заполнение всех полей профиля
- **Загрузка фото**: `/profile/upload_photo.php` - основное фото и галерея
- **Просмотр**: Профиль отображается на других страницах сайта

### 3. Хранение фотографий

- Фотографии сохраняются в `uploads/photos/{user_id}/`
- Путь в БД: `uploads/photos/{user_id}/photo_xxx.jpg`
- Основное фото: в поле `users.profile_photo`
- Дополнительные фото: в таблице `user_photos`

### 4. Сессии

- PHP сессии для текущего запроса
- Сессии в БД (`user_sessions`) для безопасности
- Время жизни: 30 дней
- Автоматическая проверка валидности

## База данных

### Обновленные таблицы

**users** - добавлены поля:
- `vk_id` - ID пользователя ВКонтакте (уникальный)
- `vk_access_token` - токен доступа ВК (опционально)
- `email`, `password_hash`, `date_of_birth`, `gender` - теперь необязательные

**user_sessions** - новая таблица для хранения сессий:
- `id` - ID сессии
- `user_id` - ID пользователя
- `session_token` - токен сессии (уникальный)
- `ip_address` - IP адрес
- `user_agent` - User Agent браузера
- `created_at` - время создания
- `expires_at` - время истечения

## Безопасность

- ✅ Хеширование паролей (для обычной регистрации)
- ✅ Защита от SQL-инъекций (prepared statements)
- ✅ Проверка типов загружаемых файлов
- ✅ Ограничение размера файлов (5MB)
- ✅ Валидация сессий в БД
- ✅ Защита личных фотографий (проверка владельца)

## Требования

- PHP 7.4+
- PostgreSQL 12+
- Расширения PHP:
  - pdo_pgsql
  - gd (для работы с изображениями)
  - json
  - session
  - fileinfo

## Возможные проблемы

### Ошибка "redirect_uri mismatch"
- Проверьте, что в настройках приложения ВК добавлен точный URL: `http://localhost:8000/auth/vk_callback.php`
- URL должен совпадать с `VK_REDIRECT_URI` в `config/vk_config.php`

### Фото не загружаются
- Проверьте права на директорию `uploads/photos` (должно быть 755 или 777)
- Убедитесь, что у PHP есть права на запись

### Ошибка подключения к БД
- Проверьте настройки в `config/db.php`
- Убедитесь, что база данных `dating-site` существует
- Проверьте пароль PostgreSQL

## Дополнительная информация

- Документация VK API: https://dev.vk.com/ru/api/overview
- OAuth ВКонтакте: https://dev.vk.com/ru/api/access-token/getting-started
